generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  CASHIER
  STAFF
  SECURITY
}

enum Gender {
  MALE
  FEMALE
}

enum SessionType {
  CLASS
  CHAPEL
}

enum DayOfWeekend {
  SATURDAY
  SUNDAY
}

model User {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String
  name      String
  role      Role
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([username])
}

model Course {
  id        String    @id @default(cuid())
  name      String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  students  Student[]
  classes   Class[]

  @@index([name])
}

model Class {
  id             String          @id @default(cuid())
  name           String
  courseId       String
  course         Course          @relation(fields: [courseId], references: [id], onDelete: Cascade)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  sessionClasses SessionClass[]
  attendances    Attendance[]

  @@unique([courseId, name])
  @@index([courseId])
}

model Weekend {
  id           String    @id @default(cuid())
  saturdayDate DateTime  @db.Date
  name         String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  sessions     Session[]
  checkIns     CheckIn[]

  @@unique([saturdayDate])
  @@index([saturdayDate])
}

model Session {
  id             String          @id @default(cuid())
  weekendId      String
  weekend        Weekend         @relation(fields: [weekendId], references: [id], onDelete: Cascade)
  day            DayOfWeekend
  sessionType    SessionType
  name           String
  startTime      String
  endTime        String
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  sessionClasses SessionClass[]
  attendances    Attendance[]

  @@index([weekendId])
  @@index([day])
  @@index([sessionType])
  // Composite indexes for optimized queries
  @@index([weekendId, sessionType]) // For finding chapel sessions by weekend
  @@index([weekendId, day]) // For finding sessions on specific days of a weekend
  @@index([sessionType, day]) // For filtering chapel sessions by day across weekends
}

model SessionClass {
  id        String   @id @default(cuid())
  sessionId String
  session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  classId   String
  class     Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sessionId, classId])
  @@index([sessionId])
  @@index([classId])
}

model Student {
  id              String       @id @default(cuid())
  admissionNumber String       @unique
  fullName        String
  gender          Gender
  courseId        String
  course          Course       @relation(fields: [courseId], references: [id])
  areaOfResidence String
  phoneNumber     String
  identification  String
  profilePicture  String?      // URL path to profile picture
  isExpelled      Boolean      @default(false)
  expelledAt      DateTime?
  expelledReason  String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  attendances     Attendance[]
  checkIns        CheckIn[]

  @@index([admissionNumber])
  @@index([courseId])
  @@index([fullName])
  @@index([isExpelled])
}

model CheckIn {
  id        String   @id @default(cuid())
  studentId String
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  weekendId String
  weekend   Weekend  @relation(fields: [weekendId], references: [id], onDelete: Cascade)
  day       DayOfWeekend
  checkedAt DateTime @default(now())
  checkedBy String

  @@unique([studentId, weekendId, day])
  @@index([studentId])
  @@index([weekendId])
  @@index([day])
  @@index([checkedAt])
  // Composite indexes for optimized queries
  @@index([weekendId, day, checkedAt]) // For getTodayCheckIns() - filter by weekend+day, order by time
  @@index([studentId, weekendId]) // For chapel attendance verification - check if student checked in this weekend
}

model Attendance {
  id        String   @id @default(cuid())
  studentId String
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  sessionId String
  session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  classId   String?
  class     Class?   @relation(fields: [classId], references: [id])
  markedAt  DateTime @default(now())
  markedBy  String

  @@unique([studentId, sessionId])
  @@index([studentId])
  @@index([sessionId])
  @@index([classId])
  // Composite indexes for optimized queries
  @@index([sessionId, classId]) // For getAttendanceBySession() with class filter
  @@index([sessionId, markedAt]) // For getAttendanceBySession() ordered by time
  @@index([studentId, markedAt]) // For student attendance history ordered by date
}
